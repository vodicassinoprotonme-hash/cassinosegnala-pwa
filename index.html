<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CassinoSegnala â€¢ Voci di Cassino</title>
  <meta name="description" content="Invia segnalazioni (anche anonime) a Voci di Cassino. I file vengono caricati su Drive e ti arriva una mail con tutti i dettagli.">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{ --bg:#0b1020; --card:#0f172a; --muted:#8ea0b6; --txt:#e2e8f0; --brand:#22c55e; --brand2:#16a34a; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0c1227 60%,#0b1020);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:940px;margin:auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;margin:6px 0 18px}
    .logo{width:44px;height:44px;border-radius:12px;background:#111 url('icons/icon-192.png') center/cover no-repeat;flex:0 0 44px}
    h1{font-size:1.35rem;margin:0}
    .sub{color:var(--muted);font-size:.95rem;margin:2px 0 0}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.15);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,.45)}
    form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1/-1}
    label{display:block;font-weight:600;margin:6px 0 6px}
    input,select,textarea{
      width:100%;background:#0a0f1e;border:1px solid rgba(148,163,184,.25);color:var(--txt);
      border-radius:12px;padding:12px 14px;font-size:1rem;outline:none
    }
    input::file-selector-button{border:0;border-radius:10px;padding:8px 10px;margin-right:10px;background:#111;color:#e5e7eb}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center}
    .hint{color:var(--muted);font-size:.9rem}
    .muted{color:var(--muted)}
    .switch{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:0;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;
      background:linear-gradient(135deg,var(--brand),var(--brand2));color:#04120a;box-shadow:0 10px 20px rgba(34,197,94,.25)
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#111;color:#e5e7eb;box-shadow:none;border:1px solid rgba(148,163,184,.2)}
    .toast{
      position:fixed;right:16px;bottom:16px;background:#0f172a;border:1px solid rgba(148,163,184,.25);
      color:var(--txt);padding:14px 16px;border-radius:14px;box-shadow:0 10px 24px rgba(2,6,23,.45);
      transform:translateY(20px);opacity:0;transition:.25s
    }
    .toast.show{transform:translateY(0);opacity:1}
    footer{margin:22px 6px 4px;color:var(--muted);font-size:.9rem;text-align:center}
    @media (max-width:720px){form{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Voci di Cassino â€” CassinoSegnala</h1>
        <p class="sub">Invia una segnalazione (anche anonima). Puoi allegare foto o video. ðŸ’¬</p>
      </div>
    </header>

    <div class="card">
      <form id="reportForm">
        <div class="full">
          <label for="categoria">Categoria</label>
          <select id="categoria" name="categoria" required>
            <option value="" disabled selected>Selezionaâ€¦</option>
            <option>Decoro urbano</option>
            <option>Traffico/Strade</option>
            <option>Sicurezza</option>
            <option>Illuminazione</option>
            <option>Ambiente/Rifiuti</option>
            <option>Altro</option>
          </select>
        </div>

        <div>
          <label for="nome">Nome (opzionale)</label>
          <input id="nome" name="nome" placeholder="Mario R. (facoltativo)" />
        </div>
        <div class="switch">
          <input type="checkbox" id="anonimo" name="anonimo" />
          <label for="anonimo" class="muted">Invia come anonimo</label>
        </div>

        <div>
          <label for="email">Email (opzionale)</label>
          <input id="email" name="email" type="email" placeholder="nome@email.com" />
        </div>
        <div>
          <label for="telefono">Telefono (opzionale)</label>
          <input id="telefono" name="telefono" type="tel" placeholder="333 1234567" />
        </div>

        <div class="full">
          <label for="oggetto">Oggetto</label>
          <input id="oggetto" name="oggetto" required placeholder="Titolo breve della segnalazione" />
        </div>

        <div class="full">
          <label for="descrizione">Descrizione</label>
          <textarea id="descrizione" name="descrizione" required placeholder="Spiega cosa succede, dove e quando."></textarea>
          <p class="hint">PiÃ¹ dettagli = piÃ¹ facile intervenire. Indica via, orario, riferimenti utili.</p>
        </div>

        <div class="full">
          <label for="allegati">Allega media (foto/video)</label>
          <input id="allegati" type="file" multiple accept="image/*,video/*" />
          <p class="hint">I file vengono caricati su Drive e nella mail riceverai i link.</p>
        </div>

        <div class="row full">
          <input type="checkbox" id="privacy" required />
          <label for="privacy">Ho letto lâ€™informativa e acconsento al trattamento dei dati ai soli fini della segnalazione.</label>
        </div>

        <input type="hidden" name="pagina" value="cassinosignal-pwa" />
        <input type="hidden" name="timestamp" id="tsField" />
      </form>

      <div class="row full" style="justify-content:flex-end;margin-top:12px">
        <button class="btn secondary" type="reset" form="reportForm">Pulisci</button>
        <button class="btn" id="sendBtn" type="submit" form="reportForm">Invia segnalazione</button>
      </div>

      <p class="hint" style="margin-top:12px">Se hai problemi, puoi usare anche il modulo alternativo:
        <a class="muted" href="https://forms.gle/ZbsHFHWLacpQedK77" target="_blank" rel="noopener">Modulo Google</a>.
      </p>
    </div>

    <footer>
      Â© Voci di Cassino â€¢ PWA. I file sono caricati su Google Drive e la mail viene inviata automaticamente dal server.
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // === Endpoint Apps Script (TUO NUOVO DEPLOY) ===
    const APPS_SCRIPT_UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxh-zpXhyWfvmmWtM6lPm69dzlWFDlO7rGoGjr6Mps9uO9L_DojpaoecXw6VE7AYO2hhA/exec";

    const form  = document.getElementById('reportForm');
    const btn   = document.getElementById('sendBtn');
    const toast = document.getElementById('toast');
    const ts    = document.getElementById('tsField');

    function showToast(msg, ok=true){
      toast.textContent = msg;
      toast.style.borderColor = ok ? 'rgba(34,197,94,.4)' : 'rgba(239,68,68,.5)';
      toast.classList.add('show');
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toast.classList.remove('show'), 5000);
    }

    function applyAnonymity(){
      const anon = document.getElementById('anonimo').checked;
      if(anon){ form.nome.value=''; form.email.value=''; form.telefono.value=''; }
    }

    async function sendToServer(){
      const fd = new FormData();
      fd.append('categoria', form.categoria.value);
      fd.append('oggetto', form.oggetto.value);
      fd.append('descrizione', form.descrizione.value);
      fd.append('nome', form.nome.value || '');
      fd.append('email', form.email.value || '');
      fd.append('telefono', form.telefono.value || '');
      fd.append('anonimo', document.getElementById('anonimo').checked ? 'si' : 'no');
      fd.append('pagina', 'cassinosignal-pwa');
      fd.append('timestamp', new Date().toISOString());

      const files = document.getElementById('allegati').files;
      Array.from(files).forEach(f => fd.append('files[]', f, f.name));
      fd.append('folder', 'CassinoSegnala');

      // 1) CORS "normale" (cosÃ¬ leggiamo il JSON)
      try {
        const res = await fetch(APPS_SCRIPT_UPLOAD_URL, { method:'POST', body:fd });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        return;
      } catch (e) {
        // 2) Fallback: consegna comunque anche se il preflight viene bloccato
        await fetch(APPS_SCRIPT_UPLOAD_URL, { method:'POST', body:fd, mode:'no-cors' });
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      applyAnonymity();
      ts.value = new Date().toISOString();

      if(!form.categoria.value || !form.oggetto.value.trim() || !form.descrizione.value.trim() || !document.getElementById('privacy').checked){
        showToast('Compila i campi obbligatori.', false);
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Invio in corsoâ€¦';

      try{
        await sendToServer();
        form.reset();
        showToast('Segnalazione inviata! âœ… Controlla la posta.');
      }catch(err){
        console.error(err);
        showToast('Errore: ' + err.message, false);
      }finally{
        btn.disabled = false;
        btn.textContent = 'Invia segnalazione';
      }
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>


