<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CassinoSignal</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Leaflet (mappa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { --brand:#0d6efd; --bg:#0b1220; --card:#121a2b; --text:#e9eefc; --muted:#b8c3e0; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--card);display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #223; z-index: 10;}
    header img{width:28px;height:28px;border-radius:6px}
    header h1{font-size:18px;margin:0}
    main{padding:16px; max-width: 900px; margin: 0 auto;}
    .tabs{display:flex;gap:8px;margin:8px 0 16px;position:sticky;top:56px; z-index: 9;}
    .tabs button{flex:1;padding:10px;border-radius:10px;border:1px solid #2a3550;background:#162038;color:var(--text);cursor:pointer}
    .tabs button.active{background:var(--brand);border-color:var(--brand)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 640px){ .row{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid #1f2942;border-radius:14px;padding:14px}
    .muted{color:var(--muted);font-size:14px}
    .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#162038;border:1px solid #2a3550;color:var(--text)}
    .field{width:100%;border-radius:10px;padding:10px;background:#0f1626;color:var(--text);border:1px solid #24304a}
    .install{position:fixed;right:12px;bottom:12px;background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(13,110,253,.35);display:none; z-index: 11;}
    #map{height: 420px; border-radius: 14px; border:1px solid #1f2942}
    .badge{display:inline-block;background:#203055;border:1px solid #2d3a60;color:#cfe0ff;padding:2px 8px;border-radius:999px;font-size:12px}
    ul{margin:0;padding-left:18px}
    footer{padding:30px 0 60px;text-align:center;color:#92a0c7;font-size:12px}
    a{color:#9ec1ff}
  </style>
</head>
<body>
  <header>
    <img src="icons/icon-192.png" alt="logo" />
    <h1>CassinoSignal</h1>
  </header>

  <main>
    <div class="tabs">
      <button data-tab="mangiare" class="active">Dove Mangiare</button>
      <button data-tab="acquistare">Dove Acquistare</button>
      <button data-tab="segnalazioni">Segnalazioni</button>
      <button data-tab="recensioni">Recensioni</button>
      <button data-tab="mappa">Mappa</button>
    </div>

    <!-- Mangiare -->
    <section id="mangiare">
      <div class="row" id="mangiare-list"></div>
    </section>

    <!-- Acquistare -->
    <section id="acquistare" hidden>
      <div class="row" id="acquistare-list"></div>
    </section>

    <!-- Segnalazioni -->
    <section id="segnalazioni" hidden>
      <div class="card">
        <h3>Invia segnalazione</h3>
        <p class="muted">Scrivi un messaggio, opzionalmente allega una foto e aggiungi la tua posizione.</p>
        <form id="report-form">
          <textarea id="msg" rows="4" class="field" placeholder="Descrivi la segnalazione..."></textarea>
          <div style="display:flex;gap:8px;margin:10px 0;flex-wrap:wrap">
            <input type="file" id="photo" accept="image/*" class="field" style="max-width:320px" />
            <button type="button" id="geo" class="btn ghost">Ottieni posizione</button>
          </div>
          <div id="coords" class="muted">Posizione: non ottenuta</div>
          <button type="submit" class="btn" style="margin-top:10px">Invia segnalazione</button>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Segnalazioni inviate</h3>
        <div id="reports-list" class="row"></div>
      </div>
    </section>

    <!-- Recensioni -->
    <section id="recensioni" hidden>
      <div class="card">
        <h3>Aggiungi recensione</h3>
        <form id="review-form" style="display:grid;gap:8px">
          <input id="rev-name" class="field" placeholder="Nome locale/negozio" />
          <select id="rev-type" class="field">
            <option value="mangiare">Dove Mangiare</option>
            <option value="acquistare">Dove Acquistare</option>
          </select>
          <input id="rev-stars" class="field" type="number" min="1" max="5" step="0.5" placeholder="Stelle (1-5)" />
          <textarea id="rev-text" rows="3" class="field" placeholder="Scrivi la recensione..."></textarea>
          <button class="btn" type="submit">Salva recensione</button>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <h3 style="margin:0">Recensioni</h3>
          <div>
            <label class="muted">Ordina per: </label>
            <select id="rev-sort" class="field" style="width:auto;display:inline-block">
              <option value="desc">Stelle ↓</option>
              <option value="asc">Stelle ↑</option>
              <option value="recent">Più recenti</option>
            </select>
          </div>
        </div>
        <div id="reviews-list" class="row" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Mappa -->
    <section id="mappa" hidden>
      <div id="map" class="card"></div>
      <div class="card" style="margin-top:12px">
        <span class="badge">Legenda</span>
        <ul>
          <li><strong>Azzurro</strong>: Dove Mangiare</li>
          <li><strong>Verde</strong>: Dove Acquistare</li>
          <li><strong>Rosso</strong>: Segnalazioni</li>
        </ul>
      </div>
    </section>

    <footer>© CassinoSignal — PWA</footer>
  </main>

  <button id="btnInstall" class="install">Installa app</button>

  <script>
    /* ===== Storage helper ===== */
    const LS = {
      get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    };

    /* ===== Seed data ===== */
    const seedMangiare = [
      { id:'m1', name:'Pizzeria Bella Napoli', stars:4.5, desc:'Pizza napoletana con forno a legna.', lat:41.4890, lng:13.8330 },
      { id:'m2', name:'Trattoria Da Gino',     stars:4.2, desc:'Cucina ciociara, pasta fresca.',    lat:41.4875, lng:13.8302 }
    ];
    const seedAcquistare = [
      { id:'a1', name:'Emporio Digitale',  stars:4.3, desc:'Elettronica e accessori.', lat:41.4865, lng:13.8294 },
      { id:'a2', name:'Boutique Cassino',  stars:4.1, desc:'Abbigliamento e accessori.', lat:41.4881, lng:13.8321 }
    ];
    const seedReviews = [
      { id:'r1', type:'mangiare', name:'Pizzeria Bella Napoli', stars:5, text:'Impasto top', ts: Date.now()-86400000 },
      { id:'r2', type:'acquistare', name:'Emporio Digitale', stars:4, text:'Staff preparato', ts: Date.now()-43200000 }
    ];

    const mangiare = LS.get('mangiare', seedMangiare);
    const acquistare = LS.get('acquistare', seedAcquistare);
    const reports = LS.get('reports', []);
    const reviews = LS.get('reviews', seedReviews);

    /* ===== Tabs ===== */
    const tabs = document.querySelectorAll('.tabs button');
    const sections = [...document.querySelectorAll('main section')];
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sections.forEach(s => s.hidden = (s.id !== btn.dataset.tab));
        if (btn.dataset.tab === 'mappa') {
          // aspetta che il DOM mostri la sezione, poi (re)inizializza
          setTimeout(() => ensureMap(), 50);
        }
        if (btn.dataset.tab === 'recensioni') renderReviews();
      });
    });

    /* ===== Render liste ===== */
    function cardItem(item){
      return `
        <div class="card">
          <h3 style="margin:0">${item.name} <span class="muted">— ★ ${item.stars}</span></h3>
          <p class="muted" style="margin:6px 0 0">${item.desc ?? ''}</p>
        </div>`;
    }
    function renderList(id, data){
      const el = document.getElementById(id);
      el.innerHTML = data.map(cardItem).join('');
    }
    renderList('mangiare-list', mangiare);
    renderList('acquistare-list', acquistare);

    /* ===== Segnalazioni ===== */
    const geoBtn = document.getElementById('geo');
    const coordsEl = document.getElementById('coords');
    let currentCoords = null;

    geoBtn?.addEventListener('click', () => {
      if (!('geolocation' in navigator)) { coordsEl.textContent = 'Posizione non supportata'; return; }
      coordsEl.textContent = 'Richiesta posizione...';
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          currentCoords = { lat: latitude, lng: longitude };
          coordsEl.textContent = `Posizione: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        },
        err => { coordsEl.textContent = 'Errore posizione: ' + err.message; },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    document.getElementById('report-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('msg').value.trim();
      const file = document.getElementById('photo').files[0];

      if (!msg) { alert('Scrivi un messaggio.'); return; }
      if (!currentCoords) { alert('Ottieni prima la posizione.'); return; }

      let photoData = null;
      if (file) {
        photoData = await fileToDataURL(file);
      }

      const report = {
        id: 'rep_'+Date.now(),
        msg, photoData,
        lat: currentCoords.lat,
        lng: currentCoords.lng,
        ts: Date.now()
      };
      reports.push(report);
      LS.set('reports', reports);
      document.getElementById('report-form').reset();
      currentCoords = null;
      coordsEl.textContent = 'Posizione: non ottenuta';
      renderReports();
      if (map) drawMarkers();
      alert('Segnalazione inviata!');
    });

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function renderReports(){
      const el = document.getElementById('reports-list');
      if (!el) return;
      if (!reports.length){ el.innerHTML = '<div class="muted">Nessuna segnalazione inviata.</div>'; return; }
      el.innerHTML = reports.slice().reverse().map(r => `
        <div class="card">
          <div style="display:flex;gap:12px;align-items:flex-start">
            ${r.photoData ? `<img src="${r.photoData}" alt="foto" style="width:92px;height:92px;object-fit:cover;border-radius:10px;border:1px solid #24304a" />` : ''}
            <div>
              <div class="badge">Segnalazione</div>
              <p style="margin:6px 0 4px">${r.msg}</p>
              <div class="muted">${new Date(r.ts).toLocaleString()} — ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
            </div>
          </div>
        </div>
      `).join('');
    }
    renderReports();

    /* ===== Recensioni ===== */
    document.getElementById('review-form')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = document.getElementById('rev-name').value.trim();
      const type = document.getElementById('rev-type').value;
      const stars = parseFloat(document.getElementById('rev-stars').value);
      const text = document.getElementById('rev-text').value.trim();
      if (!name || !stars || stars<1 || stars>5){ alert('Nome e stelle (1-5) obbligatori.'); return; }
      reviews.push({ id:'rev_'+Date.now(), type, name, stars, text, ts: Date.now() });
      LS.set('reviews', reviews);
      (e.target).reset();
      renderReviews();
      alert('Recensione salvata!');
    });

    function renderReviews(){
      const list = document.getElementById('reviews-list');
      const sort = document.getElementById('rev-sort')?.value ?? 'desc';
      let data = reviews.slice();
      if (sort==='desc') data.sort((a,b)=>b.stars-a.stars);
      if (sort==='asc')  data.sort((a,b)=>a.stars-b.stars);
      if (sort==='recent') data.sort((a,b)=>b.ts-a.ts);

      list.innerHTML = data.map(r => `
        <div class="card">
          <div class="badge">${r.type==='mangiare'?'Mangiare':'Acquistare'}</div>
          <h3 style="margin:6px 0">${r.name} — <span class="muted">★ ${r.stars}</span></h3>
          ${r.text ? `<p class="muted" style="margin:4px 0">${r.text}</p>`:''}
          <div class="muted">${new Date(r.ts).toLocaleString()}</div>
        </div>
      `).join('');
    }
    document.getElementById('rev-sort')?.addEventListener('change', renderReviews);
    renderReviews();

    /* ===== Mappa Leaflet ===== */
    let map, markersLayer;
    function ensureMap(){
      const section = document.getElementById('mappa');
      if (section.hidden) return; // ancora non visibile
      const mapEl = document.getElementById('map');
      if (!mapEl) return;

      if (!map) {
        console.log('Inizializzo Leaflet…');
        map = L.map('map', { zoomControl: true }).setView([41.487, 13.831], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
        drawMarkers();
      } else {
        console.log('Aggiorno dimensioni/marker…');
        map.invalidateSize();
        drawMarkers();
      }
    }

    function drawMarkers(){
      if (!markersLayer) return;

      markersLayer.clearLayers();

      // Mangiare (azzurro)
      mangiare.forEach(p=>{
        L.circleMarker([p.lat,p.lng], {radius:8, color:'#4ea3ff'}).addTo(markersLayer)
          .bindPopup(`<b>${p.name}</b><br/>★ ${p.stars}<br/><span class="muted">${p.desc??''}</span>`);
      });

      // Acquistare (verde)
      acquistare.forEach(p=>{
        L.circleMarker([p.lat,p.lng], {radius:8, color:'#19c37d'}).addTo(markersLayer)
          .bindPopup(`<b>${p.name}</b><br/>★ ${p.stars}<br/><span class="muted">${p.desc??''}</span>`);
      });

      // Segnalazioni (rosso)
      reports.forEach(r=>{
        L.circleMarker([r.lat,r.lng], {radius:8, color:'#ff4d4f'}).addTo(markersLayer)
          .bindPopup(`<b>Segnalazione</b><br/>${new Date(r.ts).toLocaleString()}<br/><span class="muted">${r.msg}</span>`);
      });
    }

    /* ===== Install prompt PWA ===== */
    let deferredPrompt;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.style.display = 'inline-block';
    });
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>
</body>
</html>

